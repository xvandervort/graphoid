# Bitcoin Price Tracker - Fetch from CoinMarketCap and Store in CSV
# Demonstrates Glang's network, string processing, file I/O, and time capabilities

import "io" as io
import "time" as time
import "json" as json

print("â‚¿ Bitcoin Price Tracker")
print("======================")
print("Fetching current Bitcoin price from CoinMarketCap...")

# Configuration
string url = "https://coinmarketcap.com/"
string csv_file = "bitcoin_prices.csv"

# Helper function to extract dollar amounts from a text string
func extract_dollar_amounts(text) {
    list<string> prices = []

    # Look for patterns like $123,456.78
    # We'll use string manipulation to find these patterns

    # Split by dollar signs and process each segment
    list<string> dollar_segments = text.split("$")

    list<num> indices = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    for i in indices {  # Skip first segment (before first $)
        if i < dollar_segments.size() {
            string segment = dollar_segments[i]

            # Extract the price part (numbers, commas, decimal point)
            string price_part = extract_price_from_segment(segment)

            if price_part != "NONE" and is_valid_price(price_part) {
                prices.append(price_part)
            }
        }
    }

    return prices
}

# Extract price from the beginning of a segment after $
func extract_price_from_segment(segment) {
    string result = ""

    # Go through character by character until we hit a non-price character
    list<string> chars = segment.chars()

    for char in chars {
        if char.contains("0") or char.contains("1") or char.contains("2") or
           char.contains("3") or char.contains("4") or char.contains("5") or
           char.contains("6") or char.contains("7") or char.contains("8") or
           char.contains("9") or char.contains(",") or char.contains(".") {
            result = result + char
        } else {
            break  # Stop at first non-price character
        }
    }

    if result.length() > 0 {
        return result
    }
    return "NONE"
}

# Check if a string looks like a valid price
func is_valid_price(price_str) {
    # Must have at least one digit
    if !price_str.contains("0") and !price_str.contains("1") and
       !price_str.contains("2") and !price_str.contains("3") and
       !price_str.contains("4") and !price_str.contains("5") and
       !price_str.contains("6") and !price_str.contains("7") and
       !price_str.contains("8") and !price_str.contains("9") {
        return false
    }

    # Should be reasonable length (not just a single digit)
    if price_str.length() < 2 {
        return false
    }

    # Convert to number to validate (remove commas first)
    string clean_price = price_str.replace(",", "")
    num value = clean_price.to_num()

    # Bitcoin price should be substantial (> $1000)
    return value > 1000
}

# Extract all dollar amounts from entire text
func extract_all_dollar_amounts(text) {
    return extract_dollar_amounts(text)
}

# Find the largest price from a list of price strings
func find_largest_price(price_list) {
    if price_list.size() == 0 {
        return "NONE"
    }

    string largest = price_list[0]
    num largest_value = 0

    for price_str in price_list {
        string clean = price_str.replace(",", "")
        num value = clean.to_num()

        if value > largest_value {
            largest_value = value
            largest = price_str
        }
    }

    return largest
}

# Fetch the CoinMarketCap homepage
func fetch_bitcoin_price() {
    print("ğŸŒ Fetching data from " + url)

    # Make HTTP request to CoinMarketCap
    string page_content = io.http_get(url)
    print("âœ… Successfully fetched " + page_content.length().to_string() + " characters")

    # Extract Bitcoin price using Glang's string methods
    # Looking for Bitcoin price pattern in the HTML
    # CoinMarketCap typically shows prices like: $115,469.18

    print("ğŸ” Searching for Bitcoin price patterns...")

    # First, try to find sections containing "Bitcoin" and "$"
    if page_content.contains("Bitcoin") and page_content.contains("$") {
        print("âœ… Page contains Bitcoin and price indicators")

        # Look for Bitcoin followed by price patterns
        # Strategy: Find text segments that contain both "Bitcoin" and dollar amounts

        # Split page into lines and look for relevant ones
        list<string> lines = page_content.split("\n")
        print("ğŸ“„ Analyzing " + lines.size().to_string() + " lines of HTML")

        for line in lines {
            # Look for lines that mention Bitcoin and contain dollar signs
            if (line.contains("Bitcoin") or line.contains("BTC")) and line.contains("$") {
                print("ğŸ¯ Found potential Bitcoin price line")

                # Extract all dollar amounts from this line
                list<string> potential_prices = extract_dollar_amounts(line)

                if potential_prices.size() > 0 {
                    # Look for the largest price (Bitcoin is typically highest)
                    string best_price = find_largest_price(potential_prices)
                    if best_price != "NONE" {
                        print("ğŸ’° Extracted Bitcoin price: $" + best_price)
                        return best_price
                    }
                }
            }
        }

        # Fallback: look for very large dollar amounts anywhere in the page
        print("âš ï¸  Line-by-line search failed, trying broad extraction...")
        list<string> all_prices = extract_all_dollar_amounts(page_content)

        if all_prices.size() > 0 {
            print("ğŸ” Found " + all_prices.size().to_string() + " price-like patterns")
            string largest_price = find_largest_price(all_prices)

            if largest_price != "NONE" {
                print("ğŸ’° Using largest price found: $" + largest_price)
                return largest_price
            }
        }
    } else {
        print("âŒ Page doesn't contain expected Bitcoin/price indicators")
    }

    # Complete failure
    print("âŒ Could not extract Bitcoin price from page")
    return "FAILED"
}

# Get current timestamp
func get_timestamp() {
    time current_time = time.now()
    return current_time.to_string()
}

# Append price data to CSV file
func save_to_csv(price, timestamp) {
    print("ğŸ’¾ Saving data to CSV file: " + csv_file)

    # Check if file exists, if not create with headers
    bool file_exists = io.exists(csv_file)

    if !file_exists {
        string headers = "timestamp,price_usd\n"
        io.write_file(csv_file, headers)
        print("ğŸ“ Created new CSV file with headers")
    }

    # Append the new data
    string csv_row = timestamp + "," + price + "\n"
    io.append_file(csv_file, csv_row)
    print("âœ… Successfully saved: " + timestamp + " -> $" + price)
}

# Read and display recent prices for verification
func show_recent_prices() {
    if io.exists(csv_file) {
        print("\nğŸ“Š Recent Bitcoin prices:")
        string content = io.read_file(csv_file)
        list<string> lines = content.split("\n")

        # Show last 5 entries (skip header)
        num start_index = 1  # Skip header
        num end_index = lines.size()
        num show_count = 5

        if end_index - start_index > show_count {
            start_index = end_index - show_count
        }

        list<num> show_indices = [start_index, start_index + 1, start_index + 2, start_index + 3, start_index + 4]
        for i in show_indices {
            if i < lines.size() and lines[i].trim().length() > 0 {
                string line = lines[i]
                list<string> parts = line.split(",")
                if parts.size() >= 2 {
                    string timestamp = parts[0]
                    string price = parts[1]
                    print("  " + timestamp + " -> $" + price)
                }
            }
        }
    }
}

# Main execution
print("\nğŸš€ Starting Bitcoin price fetch...")

string bitcoin_price = fetch_bitcoin_price()

if bitcoin_price != "FAILED" {
    print("\nâ° Getting current timestamp...")
    string timestamp = get_timestamp()
    print("ğŸ• Current time: " + timestamp)

    print("\nğŸ’¾ Saving to CSV...")
    save_to_csv(bitcoin_price, timestamp)

    print("\nğŸ“‹ Summary:")
    print("  â€¢ Bitcoin price: $" + bitcoin_price)
    print("  â€¢ Timestamp: " + timestamp)
    print("  â€¢ Saved to: " + csv_file)

    show_recent_prices()

    print("\nâœ¨ Bitcoin price tracking completed successfully!")
} else {
    print("\nâŒ Failed to fetch Bitcoin price. Please check:")
    print("  â€¢ Internet connection")
    print("  â€¢ CoinMarketCap website availability")
    print("  â€¢ HTML structure may have changed")
}

print("\n" + "=".repeat(50))
print("ğŸ’¡ This program demonstrates:")
print("  âœ“ HTTP requests with error handling")
print("  âœ“ HTML parsing using regex patterns")
print("  âœ“ File I/O operations (read, write, append)")
print("  âœ“ Time/timestamp handling")
print("  âœ“ CSV data format management")
print("  âœ“ Robust error handling and fallbacks")
print("=".repeat(50))