# Working Bitcoin Price Tracker
# Fetches Bitcoin price from CoinMarketCap and stores in CSV

import "io" as io
import "time" as time

print("â‚¿ Bitcoin Price Tracker")
print("======================")

# Configuration
string url = "https://coinmarketcap.com/currencies/bitcoin/"
string csv_file = "data/bitcoin_prices.csv"

# Function to extract Bitcoin price from the specific Bitcoin page metadata
func extract_bitcoin_price(text) {
    print("ğŸ’° Extracting Bitcoin price from page metadata...")

    # Look for the meta description which contains the current price
    # Pattern: "The live Bitcoin price today is $115,410.77 USD"
    if text.contains("The live Bitcoin price today is $") {
        print("ğŸ¯ Found Bitcoin price description")

        # Split to find the price segment
        list<string> parts = text.split("The live Bitcoin price today is $")
        if parts.size() > 1 {
            string price_segment = parts[1]

            # Extract price until we hit " USD"
            list<string> usd_parts = price_segment.split(" USD")
            if usd_parts.size() > 0 {
                string price = usd_parts[0]
                print("ğŸ¯ Extracted Bitcoin price: $" + price)
                return price
            }
        }
    }

    print("âŒ Could not find Bitcoin price in description metadata")
    return "FAILED"
}

# Fetch Bitcoin price from CoinMarketCap
func fetch_bitcoin_price() {
    print("ğŸŒ Fetching from " + url)

    # Get the webpage
    string content = io.http_get(url)
    print("âœ… Downloaded " + content.length().to_string() + " characters")

    # Check if page contains Bitcoin info
    if content.contains("Bitcoin") {
        if content.contains("$") {
            print("âœ… Page contains Bitcoin and price data")

            # Extract the Bitcoin price from metadata
            string price = extract_bitcoin_price(content)
            return price
        } else {
            print("âŒ Page doesn't contain expected price data")
            return "FAILED"
        }
    } else {
        print("âŒ Page doesn't contain expected Bitcoin data")
        return "FAILED"
    }
}

# Get current timestamp
func get_timestamp() {
    current = time.now()
    return current.to_string()
}

# Save price to CSV file
func save_to_csv(price, timestamp) {
    print("ğŸ’¾ Saving to " + csv_file)

    # Check if file exists
    bool file_exists = io.exists(csv_file)

    if !file_exists {
        # Create file with headers
        string headers = "timestamp,price_usd\n"
        io.write_file(csv_file, headers)
        print("ğŸ“ Created new CSV file")
    }

    # Append new data
    string new_row = timestamp + "," + price + "\n"
    io.append_file(csv_file, new_row)
    print("âœ… Saved: " + timestamp + " -> $" + price)
}

# Show recent entries
func show_recent_prices() {
    if io.exists(csv_file) {
        print("\nğŸ“Š Recent Bitcoin prices:")
        string content = io.read_file(csv_file)
        list<string> lines = content.split("\n")

        # Show last few lines (skip header)
        num total_lines = lines.size()
        num start = 1  # Skip header
        if total_lines > 6 {
            start = total_lines - 5  # Show last 5 data lines
        }

        num i = start
        while i < total_lines {
            if i < lines.size() {
                string line = lines[i].trim()
                if line.length() > 0 {
                    list<string> parts = line.split(",")
                    if parts.size() >= 2 {
                        print("  " + parts[0] + " -> $" + parts[1])
                    }
                }
            }
            i = i + 1
        }
    }
}

# Main execution
print("ğŸš€ Starting Bitcoin price fetch...")

string bitcoin_price = fetch_bitcoin_price()

if bitcoin_price != "FAILED" {
    print("\nâ° Getting timestamp...")
    string timestamp = get_timestamp()

    print("ğŸ’¾ Saving data...")
    save_to_csv(bitcoin_price, timestamp)

    print("\nğŸ“‹ Summary:")
    print("  Bitcoin Price: $" + bitcoin_price)
    print("  Timestamp: " + timestamp)
    print("  File: " + csv_file)

    show_recent_prices()

    print("\nâœ¨ Bitcoin price tracking completed successfully!")
    print("ğŸ’¡ Run this script daily to build a price history for trend analysis.")

} else {
    print("\nâŒ Failed to fetch Bitcoin price")
    print("  Check internet connection and try again")
}

print("\nğŸ”— Data source: " + url)
print("ğŸ“ Data file: " + csv_file)