#!/usr/bin/env glang

# Integration test for DataFrame group_by functionality

print("=== DataFrame Group By Integration Test ===")

# Test 1: Simple DataFrame construction with variable keys
print("1. Creating DataFrame with variable keys")

name_key = "name"
dept_key = "department"
salary_key = "salary"

# DataFrame structure with variable key assignment
employees = {
    "_type": "dataframe",
    "_columns": [name_key, dept_key, salary_key],
    "_data": [],
    "_row_count": 0
}

# Initialize columns using variable keys
employees[name_key] = []
employees[dept_key] = []
employees[salary_key] = []

print("DataFrame structure created with variable keys")

# Test 2: Add data using clean variable key syntax
print("2. Adding employee data")

alice = { name_key: "Alice", dept_key: "Engineering", salary_key: 80000 }
bob = { name_key: "Bob", dept_key: "Sales", salary_key: 60000 }
charlie = { name_key: "Charlie", dept_key: "Engineering", salary_key: 85000 }

# Add data to DataFrame
employees[name_key].append(alice[name_key])
employees[dept_key].append(alice[dept_key])
employees[salary_key].append(alice[salary_key])
employees["_row_count"] = employees["_row_count"] + 1

employees[name_key].append(bob[name_key])
employees[dept_key].append(bob[dept_key])
employees[salary_key].append(bob[salary_key])
employees["_row_count"] = employees["_row_count"] + 1

employees[name_key].append(charlie[name_key])
employees[dept_key].append(charlie[dept_key])
employees[salary_key].append(charlie[salary_key])
employees["_row_count"] = employees["_row_count"] + 1

print("Added 3 employees:")
print("Names: " + employees["name"].to_string())
print("Departments: " + employees["department"].to_string())
print("Salaries: " + employees["salary"].to_string())

# Test 3: Group by department using map.keys()
print("3. Grouping by department")

groups = {}
for i in [].upto(employees["_row_count"] - 1) {
    dept = employees["department"][i]
    salary = employees["salary"][i]

    if !groups.has_key(dept) {
        groups[dept] = []
    }

    groups[dept].append(salary)
}

# Calculate averages using map.keys()
print("Department salary averages:")
dept_keys = groups.keys()
for i in [].upto(dept_keys.size() - 1) {
    dept = dept_keys[i]
    salaries = groups[dept]

    total = 0
    for j in [].upto(salaries.size() - 1) {
        total = total + salaries[j]
    }

    avg = total / salaries.size()
    print(dept + ": $" + avg.to_string())
}

print("✅ DataFrame group_by functionality working with variable keys!")
print("✅ map.keys() enables comprehensive DataFrame operations!")